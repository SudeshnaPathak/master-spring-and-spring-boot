#Layer Caching to optimize Build Time
FROM maven:3.9.11-amazoncorretto-25-alpine AS build
WORKDIR /home/app

COPY ./pom.xml /home/app/pom.xml
COPY ./src/main/java/com/in28minutes/rest/webservices/hello_world_java/RestfulWebServicesApplication.java	/home/app/src/main/java/com/in28minutes/rest/webservices/hello_world_java/RestfulWebServicesApplication.java

RUN mvn -f /home/app/pom.xml clean package

# Docker follows a layer caching mechanism.
# The above 5 layers would be cached and reused, if there are no changes in the pom.xml or RestfulWebServicesApplication.java file
# Only if there are any changes in the pom.xml or RestfulWebServicesApplication.java file, then mvn clean package would be re-executed
# mvn clean package takes the most time in the build process, so caching the above layers helps in reducing the overall build time significantly

# Now, copy the remaining files and re-build the package
COPY . /home/app
# First mvn clean package would be re-used from the cache if there are no changes in the pom.xml or RestfulWebServicesApplication.java file
RUN mvn -f /home/app/pom.xml clean package

FROM openjdk:25-ea-jdk-slim
EXPOSE 5000
COPY --from=build /home/app/target/*.jar app.jar
ENTRYPOINT [ "sh", "-c", "java -jar /app.jar" ]

# docker build -f Dockerfile3 -t in28min/hello-world-docker:v3 .
# docker run -d -p 5000:5000 in28min/hello-world-docker:v3